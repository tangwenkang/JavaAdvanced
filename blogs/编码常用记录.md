# 编码常用记录

---

## 1.Json字符串转换

~~~java
// Json字符串转List
List<RequestFilters> params = JSON.parseArray(filters, RequestFilters.class);
// Json字符串转wrapper
QueryWrapper<FmeaProductStructure> wrapper = QueryWrapperUtils.parse(filters, FmeaProductStructure.class);
~~~

## 2.@Transactional(rollbackFor = Exception.class)放在add、edit、delete方法上

## 3.

## 模板

### Controller

~~~java

/**
* FmeaProductStructure
* @author tangwk2
* @date 2021-05-06 20:05:04
*/
@RestController
@RequestMapping("/fmeaProductStructure")
public class FmeaProductStructureController extends BaseXpController<FmeaProductStructureService, FmeaProductStructureMapper, FmeaProductStructure> {

    @Autowired
    private FmeaProductStructureUserService fmeaProductStructureUserService;

    /**
     * 分页查询
     * @param filters 查询条件
     * @param currentPage 当前页码
     * @param pageSize 分页大小
     * @return 分页查询结果
     * @throws Exception
     */
    @XpLog(name = AuthOperation.READ, note = "FMEA/产品结构树/查询产品结构树")
    @XpAuth(name = AuthOperation.READ, label = "查询")
    @GetMapping
    public IPage<FmeaProductStructureVo> search(@RequestParam String filters, @RequestParam long currentPage, @RequestParam long pageSize) throws Exception {
        return service.search(filters, currentPage, pageSize);
    }

    /**
     * 查询
     * @return 查询结果
     * @throws Exception 抛出异常
     */
    @XpLog(name = AuthOperation.READ, note = "FMEA/产品结构树/查看产品结构树列表")
    @XpAuth(name = AuthOperation.READ, label = "查询")
    @GetMapping("/tree")
    public List<Tree> tree() {
        return service.tree(true);
    }

    /**
     * 添加
     * @param fmeaProductStructureVo 产品结构Vo
     * @return 新增id
     */
    @XpLog(name = AuthOperation.CREATE, note = "FMEA/产品结构树/添加产品结构")
    @XpAuth(name = AuthOperation.CREATE, label = "添加")
    @PostMapping
    public long add(@Validated(BaseVoEntity.Add.class) @RequestBody FmeaProductStructureVo fmeaProductStructureVo) throws ServiceLayerException {
        return service.add(fmeaProductStructureVo);
    }

    /**
     * 修改
     * @param fmeaProductStructureVo 产品结构Vo
     * @return boolean 操作结果，false否 true是
     */
    @XpLog(name = AuthOperation.UPDATE, note = "FMEA/产品结构树/修改产品结构")
    @XpAuth(name = AuthOperation.UPDATE, label = "修改")
    @PutMapping
    public boolean edit(@Validated(BaseVoEntity.Update.class) @RequestBody FmeaProductStructureVo fmeaProductStructureVo) {
        return service.edit(fmeaProductStructureVo);
    }

    /**
     * 删除
     * @param id 产品结构id
     * @return boolean 操作结果，false否 true是
     */
    @XpLog(name = AuthOperation.DELETE, note = "FMEA/产品结构树/删除产品结构")
    @XpAuth(name = AuthOperation.DELETE, label = "删除")
    @DeleteMapping("/{id}")
    public boolean delete(@PathVariable long id) throws Exception {
        return service.delete(id);
    }

    /**
     * 判断产品编码是否已存在
     * @param fmeaProductStructureId 产品结构id
     * @param code 产品编码
     * @return 判断结果，false否 true是
     */
    @GetMapping("/checkExistCode")
    public boolean checkExistCode(@RequestParam long fmeaProductStructureId, @RequestParam String code) {
        return service.checkExistCode(fmeaProductStructureId, code);
    }

    /**
     * 获得产品和车型的多选框数据
     * @param filters 查询条件
     * @param currentPage 当前页
     * @param pageSize 页大小
     */
    @GetMapping("/option")
    public List<Map<String,Object>> getOption(@RequestParam String filters, @RequestParam long currentPage, @RequestParam long pageSize) {
        return service.getOption();
    }

    /**
     * 查询已分配产品结构的用户
     * @param filters 查询条件
     * @param currentPage 当前页
     * @param pageSize 分页大小
     * @return 分页结果
     */
    @XpLog(name = AuthOperation.READ, note = "FMEA/产品结构/查询未分配产品结构的用户")
    @XpAuth(name = "userConfig", label = "用户配置")
    @GetMapping("/distributeUsers")
    public IPage<FmeaProductStructureUserVo> users(@RequestParam String filters, @RequestParam long currentPage, @RequestParam long pageSize) throws Exception {
        return fmeaProductStructureUserService.users(filters, currentPage, pageSize);
    }

    /**
     * 查询未分配产品结构的用户
     * @param filters 查询条件
     * @param currentPage 当前页
     * @param pageSize 分页大小
     * @return 分页结果
     */
    @XpLog(name = AuthOperation.READ, note = "FMEA/产品结构/查询未分配产品结构的用户")
    @XpAuth(name = "userConfig", label = "用户配置")
    @GetMapping("/notDistributeUsers")
    public IPage<FmeaProductStructureUserVo> notDistributeUsers(@RequestParam String filters, @RequestParam long currentPage, @RequestParam long pageSize) throws Exception {
        return fmeaProductStructureUserService.notDistributeUsers(filters, currentPage, pageSize);
    }

    /**
     * 分配用户
     * @param fmeaProductStructureUserVo 用户Vo
     * @return 添加结果，false否 true是
     */
    @XpLog(name = AuthOperation.CREATE, note = "FMEA/产品结构树/分配用户")
    @XpAuth(name = "userConfig", label = "用户配置")
    @PostMapping("/user")
    public boolean addUsers(@Validated(BaseVoEntity.Add.class) @RequestBody FmeaProductStructureUserVo fmeaProductStructureUserVo) {
        return fmeaProductStructureUserService.addUsers(fmeaProductStructureUserVo);
    }

    /**
     * 删除分配用户
     * @param userId 分配用户id
     * @return boolean 操作结果，false否 true是
     */
    @XpLog(name = AuthOperation.DELETE, note = "FMEA/产品结构树/删除分配用户")
    @XpAuth(name = "userConfig", label = "用户配置")
    @DeleteMapping("/user/{userId}")
    public boolean deleteUser(@PathVariable long userId) {
        return fmeaProductStructureUserService.deleteUserByUserId(userId);
    }

    /**
     * 查看车型到子系统树
     * @return 查询结果
     */
    @XpLog(name = AuthOperation.READ, note = "FMEA/产品结构树/用户配置/查看车型到子系统树")
    @XpAuth(name = "userConfig", label = "用户配置")
    @GetMapping("/user/tree")
    public List<Tree> carTypeToSubSystemTree() {
        return service.carTypeToSubSystemTree();
    }

    /**
     * 获取完整产品结构树
     * @return 产品结构树
     */
    @GetMapping("/fullTree")
    public List<Tree> getFullTree() {
        return service.getFullTree();
    }
}

~~~

### Service

~~~java

/**
 * FmeaProductStructure
 *
 * @author tangwk2
 * @date 2021-05-06 20:05:04
 */
@Service
public class FmeaProductStructureService extends BaseXpService<FmeaProductStructureMapper, FmeaProductStructure> {

    /**
     * 产品结构类型，1系统 2子系统 3零部件
     */
    private static final byte[] TYPE = {1, 2, 3};

    @Value("${service-code}")
    private String statusCode;

    @Autowired
    private CarTypeService carTypeService;

    @Autowired
    private FmeaDesignService fmeaDesignService;

    @Autowired
    private FmeaProcessService fmeaProcessService;

    @Autowired
    private RoleUserService roleUserService;

    @Autowired
    private FmeaProductStructureUserService fmeaProductStructureUserService;

    @Resource
    private SecurityUtils securityUtils;

    /**
     * 获取完整产品结构树
     * @return 完整产品结构树
     */
    public List<Tree> getFullTree() {
        return buildCarType(true,true);
    }

    /**
     * 查询产品结构树列表
     * @param isBuildSubSystemOrPart 是否构建子系统和零部件
     * @return 产品结构树
     */
    public List<Tree> tree(boolean isBuildSubSystemOrPart) {
        // 是否管理员
        boolean isAdmin = this.isAdmin();
        return this.buildCarType(isBuildSubSystemOrPart, isAdmin);
    }

    /**
     * 构建车型
     * @param isBuildSubSystemOrPart 是否构建子系统和零部件
     * @param isAdmin 是否是管理员
     * @return 产品结构树
     */
    private List<Tree> buildCarType(boolean isBuildSubSystemOrPart, boolean isAdmin) {
        List<CarType> carTypes = carTypeService.list();
        List<Tree> trees = new ArrayList<>(carTypes.size());
        if (CollectionUtils.isEmpty(carTypes)) {
            return trees;
        }
        // 分配用户节点
        Map<String, Object> nodeMap = this.nodeMap();
        // 构建车型根节点
        carTypes.forEach(carType -> {
            Tree tree = new Tree();
            // 管理员可以查看全部数据
            if (isAdmin) {
                tree.setDisabled(false);
                tree.setId(carType.getId());
                tree.setName(carType.getName());
                tree.setParentNode(0L);
                Map<String, Object> map = new HashMap<>(4);
                map.put("type", 0);
                map.put("carTypeId", 0);
                tree.setMap(map);
                trees.add(tree);
            }else {
                // 非管理员根据nodeMap中carTypeId值渲染对应的车型节点
                if (!ObjectUtils.isEmpty(nodeMap.get("carTypeId")) && carType.getId() == Long.parseLong(nodeMap.get("carTypeId").toString())) {
                    tree.setId(carType.getId());
                    tree.setName(carType.getName());
                    tree.setParentNode(0L);
                    Map<String, Object> map = new HashMap<>(4);
                    map.put("type", 0);
                    map.put("carTypeId", 0);
                    tree.setMap(map);
                    trees.add(tree);
                }
                // 根据nodeMap中type值渲染节点是否可见
                tree.setDisabled(!(!ObjectUtils.isEmpty(nodeMap.get("type")) && 0 == Byte.parseByte(nodeMap.get("type").toString())));
            }
        });
        // 构建系统节点
        List<FmeaProductStructure> datas = this.list();
        if (!CollectionUtils.isEmpty(datas)) {
            trees.forEach(carTypeNode -> carTypeNode.setChildren(buildSystem(carTypeNode, datas, isBuildSubSystemOrPart, isAdmin)));
        }
        return trees;
    }

    /**
     * 构建系统
     * @param node 车型节点
     * @param datas 产品结构表全部数据
     * @param isBuildSubSystem 是否构建子系统的标志
     * @param isAdmin 是否是管理员
     * @return 系统树
     */
    private List<Tree> buildSystem(Tree node, List<FmeaProductStructure> datas, boolean isBuildSubSystem, boolean isAdmin) {
        // 过滤datas取出系统
        List<FmeaProductStructure> systems =
                datas.stream().filter(data -> TYPE[0] == data.getType()).collect(Collectors.toList());
        List<Tree> systemsNodes = new ArrayList<>(systems.size());
        // 分配用户节点
        Map<String, Object> nodeMap = this.nodeMap();

        // 构建系统节点
        systems.forEach(system -> {
            if (node.getId() == system.getCarTypeId()) {
                Tree tree = new Tree();
                // 管理员可以查看全部数据
                if (isAdmin) {
                    tree.setDisabled(false);
                    tree.setId(system.getId());
                    tree.setName(system.getName());
                    tree.setParentNode(node.getId());
                    Map<String, Object> map = new HashMap<>(16);
                    map.put("type", TYPE[0]);
                    map.put("carTypeId", system.getCarTypeId());
                    map.put("code", system.getCode());
                    map.put("packCode", system.getCode());
                    map.put("packName", system.getName());
                    map.put("viewOrder", system.getViewOrder());
                    map.put("supplierCode", system.getSupplierCode());
                    map.put("supplierName", system.getSupplierName());
                    // 根据车型id查出车型
                    CarType carType = carTypeService.getById(system.getCarTypeId());
                    map.put("carType", carType.getName());
                    tree.setMap(map);
                    if (isBuildSubSystem) {
                        tree.setChildren(buildSubSystemOrPart(tree, datas, isAdmin));
                    }
                    systemsNodes.add(tree);
                }else {
                    // 非管理员根据nodeMap中systemId值渲染对应的系统节点
                    if (!ObjectUtils.isEmpty(nodeMap.get("type")) && 0 == Byte.parseByte(nodeMap.get("type").toString()) || (!ObjectUtils.isEmpty(nodeMap.get("systemId")) && system.getId().equals(Long.parseLong(nodeMap.get("systemId").toString())))) {
                        tree.setId(system.getId());
                        tree.setName(system.getName());
                        tree.setParentNode(node.getId());
                        Map<String, Object> map = new HashMap<>(16);
                        map.put("type", TYPE[0]);
                        map.put("carTypeId", system.getCarTypeId());
                        map.put("code", system.getCode());
                        map.put("packCode", system.getCode());
                        map.put("packName", system.getName());
                        map.put("viewOrder", system.getViewOrder());
                        map.put("supplierCode", system.getSupplierCode());
                        map.put("supplierName", system.getSupplierName());
                        // 根据车型id查出车型
                        CarType carType = carTypeService.getById(system.getCarTypeId());
                        map.put("carType", carType.getName());
                        tree.setMap(map);
                        if (isBuildSubSystem) {
                            tree.setChildren(buildSubSystemOrPart(tree, datas, isAdmin));
                        }
                        systemsNodes.add(tree);
                    }
                    // 根据nodeMap中type值渲染节点是否可见
                    if (!ObjectUtils.isEmpty(nodeMap.get("type")) && 0 == Byte.parseByte(nodeMap.get("type").toString())) {
                        tree.setDisabled(false);
                    }else {
                        tree.setDisabled(!(!ObjectUtils.isEmpty(nodeMap.get("type")) && TYPE[0] == Byte.parseByte(nodeMap.get("type").toString())));
                    }
                }
            }
        });

        return systemsNodes;
    }

    /**
     * 构建子系统或零部件
     * @param node 系统节点
     * @param datas 产品结构表全部数据
     * @param isAdmin 是否管理员
     * @return 子系统树或者零部件树
     */
    private List<Tree> buildSubSystemOrPart(Tree node, List<FmeaProductStructure> datas, boolean isAdmin) {
        // 类型，1系统 2子系统 3零部件
        byte nodeType = Byte.parseByte(node.getMap().get("type").toString());
        Stream<FmeaProductStructure> stream = null;
        // 子系统或者零部件设置的类型
        byte type = 0;
        if (TYPE[0] == nodeType) {
            stream = datas.stream().filter(data -> TYPE[1] == data.getType());
            type = TYPE[1];
        }else if (TYPE[1] == nodeType) {
            stream = datas.stream().filter(data -> TYPE[2] == data.getType());
            type = TYPE[2];
        }
        List<FmeaProductStructure> fmeaProductStructures = stream.collect(Collectors.toList());
        if (CollectionUtils.isEmpty(fmeaProductStructures)) {
            return new ArrayList<>();
        }
        List<Tree> trees = new ArrayList<>(fmeaProductStructures.size());

        byte finalType = type;
        // 分配用户节点
        Map<String, Object> nodeMap = this.nodeMap();

        // 构建子系统或零部件
        fmeaProductStructures.forEach(fmeaProductStructure -> {
            if (node.getId() == fmeaProductStructure.getParentProductStructureId()) {
                Tree tree = new Tree();
                // 管理员可以查看全部数据
                if (isAdmin) {
                    tree.setDisabled(false);
                    tree.setId(fmeaProductStructure.getId());
                    tree.setName(fmeaProductStructure.getName());
                    tree.setParentNode(node.getId());
                    Map<String, Object> map = new HashMap<>(16);
                    map.put("type", finalType);
                    map.put("carTypeId", fmeaProductStructure.getCarTypeId());
                    map.put("code", fmeaProductStructure.getCode());
                    map.put("viewOrder", fmeaProductStructure.getViewOrder());
                    map.put("supplierCode", fmeaProductStructure.getSupplierCode());
                    map.put("supplierName", fmeaProductStructure.getSupplierName());
                    tree.setMap(map);
                    // 根据当前节点类型判断是否构建下一节点
                    if (finalType < TYPE.length) {
                        tree.setChildren(buildSubSystemOrPart(tree, datas, isAdmin));
                    }
                    trees.add(tree);
                }else {
                    // 子系统和零部件id集
                    List<Long> ids = FmeaProductStructureService.objToList(nodeMap.get("subSystemOrPartIds"), Long.class);
                    // 非管理员根据nodeMap中id集渲染对应的子系统节点或零部件
                    if ((!ObjectUtils.isEmpty(nodeMap.get("type")) && 0 == Byte.parseByte(nodeMap.get("type").toString()) || !ObjectUtils.isEmpty(ids) && ids.contains(fmeaProductStructure.getId()))) {
                        tree.setId(fmeaProductStructure.getId());
                        tree.setName(fmeaProductStructure.getName());
                        tree.setParentNode(node.getId());
                        Map<String, Object> map = new HashMap<>(16);
                        map.put("type", finalType);
                        map.put("carTypeId", fmeaProductStructure.getCarTypeId());
                        map.put("code", fmeaProductStructure.getCode());
                        map.put("viewOrder", fmeaProductStructure.getViewOrder());
                        map.put("supplierCode", fmeaProductStructure.getSupplierCode());
                        map.put("supplierName", fmeaProductStructure.getSupplierName());
                        tree.setMap(map);
                        // 根据当前节点类型判断是否构建下一节点
                        if (finalType < TYPE.length) {
                            tree.setChildren(buildSubSystemOrPart(tree, datas, isAdmin));
                        }
                        trees.add(tree);
                    }
                    // 根据nodeMap中type值渲染节点是否可见
                    if (!ObjectUtils.isEmpty(nodeMap.get("type")) && 0 == Byte.parseByte(nodeMap.get("type").toString())) {
                        tree.setDisabled(false);
                    }else {
                        tree.setDisabled(!(!ObjectUtils.isEmpty(nodeMap.get("type")) && TYPE[1] == Byte.parseByte(nodeMap.get("type").toString())));
                    }
                }
            }
        });
        return trees;
    }

    /**
     * 查询产品结构
     * @param filters     查询条件
     * @param currentPage 当前页
     * @param pageSize    页码
     * @return 查询结果
     * @throws Exception 抛出异常
     */
    public IPage<FmeaProductStructureVo> search(String filters, long currentPage, long pageSize) throws Exception {

        List<RequestFilters> params = JSON.parseArray(filters, RequestFilters.class);
        // 过滤params数据，取出type的param
        List<RequestFilters> carTypeParams =
                params.stream().filter(param -> 0 < param.getKey().lastIndexOf("type")).collect(Collectors.toList());
        // 过滤params数据，取出去除type的param
        List<RequestFilters> finalParams =
                params.stream().filter(param -> 0 >= param.getKey().lastIndexOf("type")).collect(Collectors.toList());
        if (!CollectionUtils.isEmpty(carTypeParams) && 0 == Integer.parseInt(carTypeParams.get(0).getValue().toString())) {
            String parentProductStructureId = "m_fmea_product_structure.parentProductStructureId";
            String carTypeId = "m_fmea_product_structure.fk_car_type_id";

            finalParams.stream().filter(param -> parentProductStructureId.equals(param.getKey())).forEach(param -> param.setKey(carTypeId));
        }
        // 把nodeId添加进去
        List<Long> ids = this.nodeIds();
        RequestFilters requestFilters = new RequestFilters();
        requestFilters.setKey("m_fmea_product_structure.id");
        requestFilters.setValue(CollectionUtils.isEmpty(ids) ? "0" : StringUtils.join(ids, ","));
        requestFilters.setOperation("inSql");
        finalParams.add(requestFilters);

        QueryWrapper<FmeaProductStructure> wrapper = QueryWrapperUtils.parse(finalParams, FmeaProductStructure.class);
        wrapper.eq("m_fmea_product_structure.is_deleted", 0)
                .orderByAsc("m_fmea_product_structure.view_order");

        return this.baseMapper.search(new Page<>(currentPage, pageSize), wrapper);
    }

    /**
     * 添加产品结构
     * @param fmeaProductStructureVo 产品结构Vo
     * @return 添加产品结构id
     */
    @Transactional(rollbackFor = Exception.class)
    public long add(FmeaProductStructureVo fmeaProductStructureVo) throws ServiceLayerException {
        // 注意，前端对点前节点的type + 1
        if (TYPE.length < fmeaProductStructureVo.getType()) {
            throw new ServiceLayerException(Integer.parseInt(statusCode + StatusCode.INVALID_PARAM.getCode()),
                    "零部件下不能添加产品！！！");
        }
        FmeaProductStructure fmeaProductStructure = new FmeaProductStructure();
        BeanUtils.copyProperties(fmeaProductStructureVo, fmeaProductStructure);
        // 判断是否是车型节点，如果是车型，parentProductStructureId设置为0
        if (1 == fmeaProductStructureVo.getType()) {
            // 车型id=vo实体的父节点id
            long carTypeId = fmeaProductStructureVo.getParentProductStructureId();
            // 父节点id设为0
            long parentProductStructureId = 0;
            fmeaProductStructure.setCarTypeId(carTypeId);
            fmeaProductStructure.setParentProductStructureId(parentProductStructureId);
        }
        boolean checkSave = this.save(fmeaProductStructure);
        return checkSave ? fmeaProductStructure.getId() : 0;
    }

    /**
     * 修改产品结构
     * @param fmeaProductStructureVo 产品结构Vo
     * @return 操作结果，false否 true是
     */
    @Transactional(rollbackFor = Exception.class)
    public boolean edit(FmeaProductStructureVo fmeaProductStructureVo) {
        FmeaProductStructure fmeaProductStructure = new FmeaProductStructure();
        BeanUtils.copyProperties(fmeaProductStructureVo, fmeaProductStructure);
        return saveOrUpdate(fmeaProductStructure);
    }

    /**
     * 删除产品结构
     * @param id 产品结构id
     * @return 操作结果， false否 true是
     */
    @Transactional(rollbackFor = Exception.class)
    public boolean delete(Long id) throws Exception {
        // 判断产品结构树是否已生成FMEA台账，已生成不能删除
        QueryWrapper<FmeaDesign> wrapper = new QueryWrapper<>();
        wrapper.select("id")
                .eq("fk_product_structure_id", id);
        List<FmeaDesign> fmeaDesigns = fmeaDesignService.list(wrapper);
        QueryWrapper<FmeaProcess> wrapper2 = new QueryWrapper<>();
        wrapper2.select("id")
                .eq("fk_product_structure_id", id);
        List<FmeaProcess> fmeaProcesses = fmeaProcessService.list(wrapper2);
        if (!CollectionUtils.isEmpty(fmeaDesigns) || !CollectionUtils.isEmpty(fmeaProcesses)) {
            throw new ServiceLayerException(Integer.parseInt(statusCode + StatusCode.INVALID_PARAM.getCode()),
                    "该产品结构已被DFMEA台账或PFMEA使用，不能删除！！！");
        }
        // 没有生成FMEA台账可以删除
        return removeById(id);
    }

    /**
     * 查询车型到系统产品结构树
     * @return 查询结果
     */
    public List<Tree> carTypeAndSystemTree() {
        return this.tree(false);
    }

    /**
     * 判断产品编码是否已存在
     * @param id 产品结构id
     * @param code 产品编码
     * @return 判断结果，false否 true是
     */
    public boolean checkExistCode(Long id, String code) {
        QueryWrapper<FmeaProductStructure> wrapper = new QueryWrapper<>();
        wrapper.select("id")
                .eq("code", code);
        List<FmeaProductStructure> fmeaProductStructures = this.list(wrapper);
        // 产品编码不存在
        if (CollectionUtils.isEmpty(fmeaProductStructures)) {
            return false;
        }else {// 产品编码存在，判断是新增操作还是修改操作，id相等即修改操作，否则是新增操作
            return !(null != id && id.equals(fmeaProductStructures.get(0).getId()));
        }
    }
    /**
     * 获得产品和车型的多选框数据
     */
    public List<Map<String,Object>> getOption() {
        List<Tree> list=tree(true);
        List<Map<String,Object>> optionList=list.stream().map(e ->{
            Map<String,Object> carMap=new HashMap();
            carMap.put("id","0");
            carMap.put("name",e.getName());

            // 车型内部的产品数据
            List<Map<String,String>> options=e.getChildren().stream().map(m ->{
                Map<String,String> map=new HashMap();
                map.put("id",""+m.getId());
                map.put("name",m.getName());
                return  map;
            }).collect(Collectors.toList());
            carMap.put("options",options);
            return carMap;
        }).collect(Collectors.toList());
        return  optionList;
    }

    /**
     * 分配用户的节点
     * @return 分配用户的节点信息
     */
    private Map<String, Object> nodeMap() {
        Map<String, Object> currentUser = securityUtils.getLoginUser();
        long userId = CollectionUtils.isEmpty(currentUser) ? 0L : Long.parseLong(currentUser.get("userId").toString());
        Map<String, Object> map = new HashMap<>(8);

        QueryWrapper<FmeaProductStructureUser> wrapper = new QueryWrapper<>();
        wrapper.eq("fk_user_id", userId);
        // 根据userId取出中间表信息
        FmeaProductStructureUser fmeaProductStructureUser = fmeaProductStructureUserService.getOne(wrapper, false);

        if (!ObjectUtils.isEmpty(fmeaProductStructureUser)) {
            // 中间表的产品结构id
            Long productStructureId = fmeaProductStructureUser.getProductStructureId();
            // 中间表的车型
            map.put("type", fmeaProductStructureUser.getType());
            // type = 0说明是车型节点分配用户，可以查看该车型下所有节点，分配用户权限类型只有0,1,2
            if (0 == fmeaProductStructureUser.getType()) {
                map.put("carTypeId", productStructureId);
            }else if (TYPE[0] == fmeaProductStructureUser.getType()) {
                FmeaProductStructure fmeaProductStructure = this.getById(productStructureId);
                map.put("carTypeId", fmeaProductStructure.getCarTypeId());
                map.put("systemId", productStructureId);
            }else if (TYPE[1] == fmeaProductStructureUser.getType()) {
                FmeaProductStructure fmeaProductStructure = this.getById(productStructureId);
                map.put("carTypeId", fmeaProductStructure.getCarTypeId());
                map.put("systemId", fmeaProductStructure.getParentProductStructureId());
                // 子系统需要把零部件取出来
                QueryWrapper<FmeaProductStructure> queryWrapper = new QueryWrapper<>();
                queryWrapper.eq("fk_parent_product_structure_id", productStructureId);
                List<FmeaProductStructure> parts = this.list(queryWrapper);
                List<Long> ids = new ArrayList<>(parts.size() + 1);
                ids.add(productStructureId);
                parts.forEach(part -> ids.add(part.getId()));
                map.put("subSystemOrPartIds", ids);
            }
        }
        return map;
    }

    /**
     * 分配用户权限下的所有id
     * @return List id集
     */
    public List<Long> nodeIds() throws ServiceLayerException {

        Map<String, Object> loginUser = securityUtils.getLoginUser();
        long userId = CollectionUtils.isEmpty(loginUser) ? 0 : Long.parseLong(loginUser.get("userId").toString());
        if (0 == userId) {
            throw new ServiceLayerException(Integer.parseInt(statusCode + StatusCode.INVALID_PARAM), "用户不存在!!!");
        }

        QueryWrapper<FmeaProductStructureUser> wrapper = new QueryWrapper<>();
        wrapper.eq("fk_user_id", userId);
        // 根据用户id取出中间表信息
        FmeaProductStructureUser fmeaProductStructureUser = fmeaProductStructureUserService.getOne(wrapper);

        // 管理员返回全部产品id
        if (roleUserService.isAdmin(userId)) {
            return this.list().stream().map(FmeaProductStructure::getId).collect(Collectors.toList());
        }

        List<Long> ids = new ArrayList<>();
        if (!ObjectUtils.isEmpty(fmeaProductStructureUser)) {
            // 0车型 1系统 2子系统 3零部件（分配用户不会分到该类型）
            byte type = fmeaProductStructureUser.getType();
            long id = fmeaProductStructureUser.getProductStructureId();
            QueryWrapper<FmeaProductStructure> queryWrapper = new QueryWrapper<>();
            if (0 == type) {
                // 类型 = 0，通过车型id取出所有产品
                queryWrapper.eq("fk_car_type_id", id);
                List<FmeaProductStructure> list = this.list(queryWrapper);
                ids = list.stream().map(FmeaProductStructure::getId).collect(Collectors.toList());
            }else if (TYPE[0] == type) {
                // 类型 = 1，id集只包含该分配节点的产品id
                ids.add(id);
            }else if (TYPE[1] == type) {
                // 类型 = 2，根据该分配节点的产品id取出全部零部件id
                queryWrapper.eq("fk_parent_product_structure_id", id);
                List<FmeaProductStructure> list = this.list(queryWrapper);
                ids = list.stream().map(FmeaProductStructure::getId).collect(Collectors.toList());
                ids.add(id);
            }
        }
        return ids;
    }

    /**
     * 是否管理员
     * @return boolean true是 false否
     */
    private boolean isAdmin() {
        Map<String, Object> loginUser = securityUtils.getLoginUser();
        long userId = Long.parseLong(loginUser.get("userId").toString());
        return roleUserService.isAdmin(userId);
    }

    /**
     * 对象转List
     * @param obj 对象
     * @param clazz class
     * @param <T> 泛型
     * @return List
     */
    private static <T> List<T> objToList(Object obj, Class<T> clazz) {
        List<T> result = new ArrayList<>();
        if(obj instanceof List<?>) {
            for (Object o : (List<?>) obj) {
                result.add(clazz.cast(o));
            }
            return result;
        }
        return null;
    }

    /**
     * 构建车型到子系统树
     * @return 树结果
     */
    public List<Tree> carTypeToSubSystemTree() {
        // 取出子系统数据
        List<FmeaProductStructure> subSystems =
                this.list().stream().filter(data -> TYPE[1] == data.getType()).collect(Collectors.toList());
        // 得到车型到系统的树
        List<Tree> finalTrees = this.carTypeAndSystemTree();

        finalTrees.forEach(carType -> {
            carType.getChildren().forEach(system -> {
                List<Tree> trees = new ArrayList<>();

                subSystems.forEach(subSystem -> {
                    if (subSystem.getParentProductStructureId() == system.getId()) {
                        Tree tree = new Tree();
                        tree.setDisabled(false);
                        tree.setId(subSystem.getId());
                        tree.setName(subSystem.getName());
                        tree.setParentNode(system.getId());
                        Map<String, Object> map = new HashMap<>(16);
                        map.put("type", TYPE[1]);
                        map.put("carTypeId", subSystem.getCarTypeId());
                        map.put("code", subSystem.getCode());
                        map.put("viewOrder", subSystem.getViewOrder());
                        map.put("supplierCode", subSystem.getSupplierCode());
                        map.put("supplierName", subSystem.getSupplierName());

                        tree.setMap(map);
                        trees.add(tree);
                    }
                });
                system.setChildren(trees);
            });
        });
        return finalTrees;
    }
}

~~~

### mapper

~~~java

/**
* FmeaProductStructure
* @author tangwk2
* @date 2021-05-06 20:05:04
*/
@Component
public interface FmeaProductStructureMapper extends BaseXpMapper<FmeaProductStructure> {
    /**
     * 查询产品结构
     * @param page 分页
     * @param wrapper 查询条件
     * @return 分页结果
     */
    IPage<FmeaProductStructureVo> search(Page<FmeaProductStructureVo> page, @Param(Constants.WRAPPER) QueryWrapper<FmeaProductStructure> wrapper);

}

~~~

~~~xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xiaopeng.xpqbamaindata.boot.mapper.FmeaProductStructureMapper">

    <select id="search" resultType="com.xiaopeng.xpqbamaindata.boot.vo.FmeaProductStructureVo">
        select
            m_fmea_product_structure.id,
            m_fmea_product_structure.fk_car_type_id as car_type_id,
            m_fmea_product_structure.fk_parent_product_structure_id as parent_product_structure_id,
            mfps.name as parent_product_structure_name,
            m_fmea_product_structure.code,
            m_fmea_product_structure.name,
            m_fmea_product_structure.type,
            m_fmea_product_structure.supplier_code,
            m_fmea_product_structure.supplier_name,
            m_fmea_product_structure.view_order
            from m_fmea_product_structure
            left join m_fmea_product_structure mfps on m_fmea_product_structure.fk_parent_product_structure_id = mfps.id ${ew.customSqlSegment}
    </select>

</mapper>
~~~

### 单元测试

~~~java

/**
 * @ClassName FmeaProductStructureControllerTest
 * @Description 产品结构单元测试
 * @Author tangwk2
 * @Date 2021-5-27 15:14
 * @Version 1.0.0
 */
@SpringBootTest
public class FmeaProductStructureControllerTest extends BaseTest {

    @MockBean
    private SecurityUtils securityUtils;

    @MockBean
    private RoleUserService roleUserService;

    @MockBean
    private UserService userService;

    /**
     * 转换成map
     * @param response
     * @return
     * @throws IOException
     */
    private Map<String, Object> convertMap(MockHttpServletResponse response) throws IOException {
        if (StringUtils.isEmpty(response.getContentAsString())) {
            return new HashMap<>();
        }
        return objectMapper.readValue(response.getContentAsString(), Map.class);
    }

    /**
     * 查询
     * @throws Exception
     */
    @Test
    public void search() throws Exception {

        String reqUrl = "/fmeaProductStructure";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .param("filters", "[]")
                .param("currentPage", "1")
                .param("pageSize", "20")
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 查询树
     * @throws Exception
     */
    @Test
    public void tree() throws Exception {

        this.admin();

        String reqUrl = "/fmeaProductStructure/tree";
        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);


        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 管理员权限
     */
    private void admin() {

        Map<String, Object> map = new HashMap<>();
        map.put("userId", 1L);

        Mockito.when(securityUtils.getLoginUser()).thenReturn(map);
        Mockito.when(roleUserService.isAdmin(Mockito.anyLong())).thenReturn(true);
    }

    /**
     * 添加
     * @throws Exception
     */
    @Transactional
    @Rollback
    @Test
    public void add() throws Exception {

        String reqUrl = "/fmeaProductStructure";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.post(reqUrl)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        FmeaProductStructure fmeaProductStructure = new FmeaProductStructure();
        fmeaProductStructure.setCarTypeId(1L);
        fmeaProductStructure.setParentProductStructureId(0L);
        fmeaProductStructure.setCode("PACK3");
        fmeaProductStructure.setName("PACK3");
        byte type = 1;
        fmeaProductStructure.setType(type);
        fmeaProductStructure.setSupplierCode("xp");
        fmeaProductStructure.setSupplierName("小鹏");

        MvcResult mvcResult = mockMvc.perform(requestBuilder.content(objectMapper.writeValueAsString(fmeaProductStructure)))
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 修改
     * @throws Exception
     */
    @Transactional
    @Rollback
    @Test
    public void edit() throws Exception {

        String reqUrl = "/fmeaProductStructure";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.put(reqUrl)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        FmeaProductStructure fmeaProductStructure = new FmeaProductStructure();
        fmeaProductStructure.setId(1L);
        fmeaProductStructure.setCode("PACK3");
        fmeaProductStructure.setName("PACK3");
        fmeaProductStructure.setCarTypeId(1L);
        fmeaProductStructure.setParentProductStructureId(0L);
        fmeaProductStructure.setViewOrder(1);
        fmeaProductStructure.setSupplierCode("xp");
        fmeaProductStructure.setSupplierName("小鹏");

        MvcResult mvcResult = mockMvc.perform(requestBuilder.content(objectMapper.writeValueAsString(fmeaProductStructure)))
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 删除
     * @throws Exception
     */
    @Transactional
    @Rollback
    @Test
    public void delete() throws Exception {

        String reqUrl = "/fmeaProductStructure/{id}";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.delete(reqUrl, 1)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 判断产品编码是否存在
     * @throws Exception
     */
    @Test
    public void checkExistCode() throws Exception {

        String reqUrl = "/fmeaProductStructure/checkExistCode";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .param("fmeaProductStructureId", "1")
                .param("code", "系统")
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 获得产品和车型的多选框数据
     * @throws Exception
     */
    @Test
    public void getOption() throws Exception {

        this.admin();

        String reqUrl = "/fmeaProductStructure/option";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .param("filters", "[]")
                .param("currentPage", "1")
                .param("pageSize", "20")
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 查询已分配产品结构的用户
     * @throws Exception
     */
    @Test
    public void users() throws Exception {

        Mockito.when(userService.search("[]", 1L, 20L)).thenReturn(new Page<>());

        String reqUrl = "/fmeaProductStructure/distributeUsers";
        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .param("filters", "[]")
                .param("currentPage", "1")
                .param("pageSize", "20")
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 查询未分配产品结构的用户
     * @throws Exception
     */
    @Test
    public void notDistributeUsers() throws Exception {

        Mockito.when(userService.search("[]", 1L, 20L)).thenReturn(new Page<>());

        String reqUrl = "/fmeaProductStructure/notDistributeUsers";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .param("filters", "[]")
                .param("currentPage", "1")
                .param("pageSize", "20")
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 分配用户
     * @throws Exception
     */
    @Transactional
    @Rollback
    @Test
    public void addUsers() throws Exception {

        String reqUrl = "/fmeaProductStructure/user";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.post(reqUrl)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        UserVo userVo = new UserVo();
        userVo.setId(10213L);
        List<UserVo> userList = new ArrayList<>();
        userList.add(userVo);

        FmeaProductStructureUserVo fmeaProductStructureUserVo = new FmeaProductStructureUserVo();
        fmeaProductStructureUserVo.setProductStructureId(1L);
        fmeaProductStructureUserVo.setType(Byte.parseByte("1"));
        fmeaProductStructureUserVo.setUsers(userList);

        MvcResult mvcResult = mockMvc.perform(requestBuilder.content(objectMapper.writeValueAsString(fmeaProductStructureUserVo)))
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 删除分配用户
     * @throws Exception
     */
    @Transactional
    @Rollback
    @Test
    public void deleteUser() throws Exception {

        String reqUrl = "/fmeaProductStructure/user/{userId}";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.delete(reqUrl, 1)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 查看车型到子系统树
     * @throws Exception
     */
    @Test
    public void carTypeToSubSystemTree() throws Exception {

        this.admin();

        String reqUrl = "/fmeaProductStructure/user/tree";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }

    /**
     * 获取完整树
     * @throws Exception
     */
    @Test
    public void getFullTree() throws Exception {

        this.admin();

        String reqUrl = "/fmeaProductStructure/fullTree";

        MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get(reqUrl)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .header("IT-REQ-WRAP", true);

        MvcResult mvcResult = mockMvc.perform(requestBuilder)
                .andExpect(status().isOk())
                .andDo(print())
                .andReturn();

        Assert.assertEquals(0, convertMap(mvcResult.getResponse()).get("code"));
    }
}

~~~

